name: Release

on:
  push:
    tags:
      - '*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate Release Note
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          wget --header="Authorization: Bearer ${GITHUB_TOKEN}" ${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/releases\?per_page\=1 -O releases.json
          cat releases.json | jq
          LATEST_TAG=`cat releases.json | jq -r '.[0].tag_name'`
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            NEXT_TAG=`echo ${GITHUB_REF} | grep -E -o '[0-9]+\.[0-9]+\.[0-9]+'`
            echo "# Release ${NEXT_TAG}" > release_note.md
            echo "" >> release_note.md
            echo "## Changes from \`${LATEST_TAG}\` to \`${NEXT_TAG}\`" >> release_note.md
            echo "" >> release_note.md
            git log --pretty="* %h - %s" ${LATEST_TAG}..${NEXT_TAG} | tee -a release_note.md
          else
            HEAD_HASH=`git rev-parse --short HEAD`
            echo "# Development Build" > release_note.md
            echo "" >> release_note.md
            echo "## Changes from \`${LATEST_TAG}\` to \`${HEAD_HASH}\`" >> release_note.md
            echo "" >> release_note.md
            git log --pretty="* %h - %s" ${LATEST_TAG}..HEAD | tee -a release_note.md
          fi
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Setup
        run: |
          ./setup.sh
      - name: Archive
        run: |
          xcodebuild clean archive \
            -scheme mpvx \
            -configuration Release \
            -archivePath build/mpvx.xcarchive \
            -destination "platform=macOS"
          mkdir -p build/Build/Products/Release
          cp -R build/mpvx.xcarchive/Products/Applications/mpvx.app build/Build/Products/Release/mpvx.app
      - name: Install create-dmg
        run: |
          brew install create-dmg
      - name: Create .dmg with Applications folder
        run: |
          mkdir -p dist
          create-dmg \
            --volname "mpvx" \
            --window-pos 200 200 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 400 200 \
            --icon "mpvx.app" 200 200 \
            ./dist/mpvx.dmg \
            ./build/Build/Products/Release/mpvx.app
      - name: Download latest Sparkle CLI
        run: |
          wget ${GITHUB_API_URL}/repos/sparkle-project/Sparkle/releases/latest -O sparkle.json
          cat sparkle.json | jq
          DOWNLOAD_URL=`cat sparkle.json | jq -r '.assets[] | select(.name | endswith(" Sparkle-for-Swift-Package-Manager.zip")).browser_download_url'`
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "Error: Could not find a Sparkle-for-Swift-Package-Manager.zip asset in the latest Sparkle release."
            exit 1
          fi
          echo "Downloading Sparkle CLI from \`${DOWNLOAD_URL}\`..."
          wget -O /tmp/Sparkle-for-Swift-Package-Manager.zip "${DOWNLOAD_URL}"
          echo "Unzipping Sparkle CLI to \`/tmp/sparkle\`..."
          unzip /tmp/Sparkle-for-Swift-Package-Manager.zip -d /tmp/sparkle
          echo "Making CLI tools executable..."
          chmod +x /tmp/sparkle/bin/generate_appcast
          chmod +x /tmp/sparkle/bin/sign_update
          echo "Copying \`generate_appcast\` and \`sign_update\` to \`${GITHUB_WORKSPACE}/\`..."
          cp /tmp/sparkle/bin/generate_appcast $GITHUB_WORKSPACE/
          cp /tmp/sparkle/bin/sign_update $GITHUB_WORKSPACE/
      - name: Decode and save private key
        run: |
          echo "${{ secrets.SPARKLE_ED25519_PRIVATE_BASE64 }}" | base64 --decode > ed25519_private.pem
          chmod 600 ed25519_private.pem
      - name: Get Tag
        id: get_tag
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      - name: Generate Appcast
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mkdir -p dist/appcast
          # The base URL for GitHub release downloads:
          #   https://github.com/<OWNER>/<REPO>/releases/download/<TAG>/
          ./generate_appcast \
            -f ed25519_private.pem \
            -o dist/appcast \
            -u "https://github.com/${{ github.repository }}/releases/download/${{ steps.get_tag.outputs.tag }}/" \
            dist
      - name: Upload .dmg artifact
        uses: actions/upload-artifact@v4
        with:
          name: mpvx.dmg
          path: ./dist/mpvx.dmg
      - name: Upload appcast artifact
        uses: actions/upload-artifact@v4
        with:
          name: appcast
          path: ./dist/appcast/appcast.xml
      - name: Upload release note
        uses: actions/upload-artifact@v4
        with:
          name: release_note.md
          path: ./release_note.md
      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./dist/mpvx.dmg
            ./dist/appcast/appcast.xml
          body_path: release_note.md
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
